---
title: "Spatial Data Basics"
output: html_notebook
---
* Dante Christopher-Alphonso <dantealphonso@gmail.com>

## Libraries
```{r}
# Loading packages for being able to manipulate and plot spatial data
library(tidyverse)
library(sf)
library(ggplot2)
library(dplyr)
```

## Data
```{r}
# Reading in the Former Municipality Boundaries Data GeoJson file and reprojecting
fmbd <- st_read('data/Former Municipality Boundaries Data.geojson') %>% st_transform(3857)

# Reading in the Community Shelters shapefile and reprojecting
shelters <- st_read("data/Shelter/shelters_wgs84.shp") %>% st_transform(3857)

# Reading in the Waste GeoJson File and reprojecting
waste <- st_read("data/waste.geojson") %>% st_transform(3857)

# Reading in the City Wards Data GeoJson File and reprojecting
cwd <- st_read("data/City Wards Data.geojson") %>% st_transform(3857)
``` 
## Functions
### Buffer and spatial join function
```{r}
#'Buffers geodataframe 1 and joins it to the nearest geometries in geodataframe 2.
#'
#'@param gdf1 A geodataframe with points.
#'@param gdf2 A geodataframe with polygons.
#'@param dist Buffer distance to apply. Default is 1000.
#'
#'@return The geodataframe after applying a buffer to gdf1 and joining to geometries of gdf2.
buffer_sjoin <- function(gdf1, gdf2, dist = 1000){
  
  # Buffer gdf1 by dist
  gdf1_buff <- st_buffer(gdf1, dist)
  
  # Join the geometries of gdf2 with buffered gdf1
  result <- st_join(gdf1_buff, gdf2)
  
  return(result)
}
```

### Spatial join and count function
```{r}
#'Takes geodataframe 1 and joins it to the geometries in geodataframe 2, then counts the number of points from      geodataframe 1.
#'
#'@param gdf1 A geodataframe with points.
#'@param gdf2 A geodataframe with polygons.
#'
#'@return The geodataframe after joining gdf1 and gdf2 and counting the number of points from gdf1.
sjoin_count <- function(gdf1, gdf2){
  
  # Join the geometries of gdf1 with gdf2
  sjoin_gdf1_gdf2 <- st_join(gdf1, gdf2)
  
  # Count the number of points per AREA_NAME
  points_count <- count(as_tibble(sjoin_gdf1_gdf2), AREA_NAME)
  
  # Rename the count column
  points_count <- rename(points_count, points_count = n)
  
  # Left join gdf2 with the points_count dataframe
  result <- left_join(gdf2, points_count, by =  "AREA_NAME")
                                  
  return(result)
}
```


### Buffer_sjoin demo
#### Demo
```{r}
# Join shelters and fmbd together after buffering shelters
# Note the default distance is 1000, but it can be changed
# e.g. buffer_sjoin(shelters, fmbd, dist = 100) for a 100 meter buffer
buffer_sjoin_shelters_fmbd <- buffer_sjoin(shelters, fmbd)
```

#### Display non-spatial data
```{r}
# Showing non-spatial results of buffer_sjoin
buffer_sjoin_shelters_fmbd
```

#### Display spatial data
```{r}
# Spatially plot the results of the buffer_sjoin function
plot(st_geometry(buffer_sjoin_shelters_fmbd))
```
### Sjoin_count demo
#### Demo
```{r}
# Counting points from waste after joining it to cwd
sjoin_count_waste_cwd <- sjoin_count(waste, cwd)
```

#### Display non-spatial data
```{r}
# Showing non-spatial results of sjoin_count
sjoin_count_waste_cwd
```
#### Display spatial data
```{r}
# Spatially plot the results of the sjoin_count function
ggplot() +
  geom_sf(data = sjoin_count_waste_cwd, aes(fill = points_count)) +
  scale_fill_viridis_c(name = "Count", na.value = "grey50") +
  labs(title = "Count of Observations by City Ward")
```
## Data Structures
### Creating list and dictionary
```{r}
# Creating a list with the Former Municipalities Boundary Data and City Wards Data geodataframes
gdf_list <- list(fmbd, cwd)

# Creating dictionary with the shelters and waste dataframes
gdf_dict <- list(shelters = shelters, waste = waste)
```

### Plotting geodataframes from the list
```{r}
# Plotting the Former Municipalities Boundary Data dataframe from list
ggplot()+
  geom_sf(data = gdf_list[[1]])

# Plotting the City Wards Data dataframe from list
ggplot()+
  geom_sf(data = gdf_list[[2]])
```
### Plotting geodataframes from the dictionary
```{r}
# Plotting the Shelters dataframe from dictionary
ggplot()+
  geom_sf(data = gdf_dict[["shelters"]])

# Plotting the Waste dataframe from dictionary
ggplot()+
  geom_sf(data = gdf_dict[["waste"]])
```
## For Loops
### Spatially plotting every list item
```{r}
# Using a For Loop for every dataframe in the list
for (gdf in gdf_list) {
 
  # Plotting every geodataframe in the list
  list_plot <- ggplot() +
    geom_sf(data = gdf)
  
  # Displaying spatial plots for every dataframe in the list
  print(list_plot)
}
```
### Spatially plotting every dictionary item
```{r}
# Using a For Loop for every dataframe in the dictionary
for (key in names(gdf_dict)) {
  
  # Plotting every dataframe in the dictionary
  dict_plot <- ggplot() +
    geom_sf(data = gdf_dict[[key]])
  
  # Displaying spatial plots for every dataframe in the dictionary
  print(dict_plot)
}
```
### Apply buffer in every list item and spatially plot them
```{r}
# Using a For Loop for every dataframe in the list
for (gdf in gdf_list) {
 
  # Apply a 1000 metre buffer to every item in the list
  gdf_buffer1 <- st_buffer(gdf, dist = 1000)
  
  # Plotting every buffered dataframe in the list
  list_plot <- ggplot() +
    geom_sf(data = gdf_buffer1)
  
  # Displaying spatial plots for every buffered dataframe in the list
  print(list_plot)
}
```
### Apply buffer to all dictionary items, spatially plot them and save them
```{r}
# Define folder paths where you want to save the buffered dataframes
output_folder <- "data/buffers/"

# Using a For Loop for every dataframe in the dictionary
for (key in names(gdf_dict)) {
  
  # Apply a 1000 metre buffer to every item in the dictionary
  gdf_buffer2 <- st_buffer(gdf_dict[[key]], dist = 1000)
  
  # Plotting every buffered dataframe in the dictionary
  dict_plot <- ggplot() +
    geom_sf(data = gdf_buffer2)
  
  # Displaying spatial plots for every buffered dataframe in the dictionary
  print(dict_plot)
  
  # Define the path where the buffered dataframe will be saved
  output_path <- paste0(output_folder, key, "_buffers.geojson")
  
  # Saves the buffered dataframes to the buffers folder
  st_write(gdf_buffer2, output_path)
}
```

